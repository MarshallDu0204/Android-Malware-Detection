import os
import re
import codecs
from tqdm import tqdm

def get_davikcode_token():
	dalvik_tokens = {}

	with open("DalvikOpcodes.txt") as fop:
		for linee in fop:
			(key, val) = linee.split()
			if val not in dalvik_tokens:
				dalvik_tokens[val] = len(dalvik_tokens)

	return dalvik_tokens

def get_opcode_seq(smali_fname,dalvik_opcodes):

	# Returns opcode sequence created from smali file 'smali_fname'.

	opcode_seq=''

	with open(smali_fname, mode="r") as bigfile:
		reader = bigfile.read()
		for i, part in enumerate(reader.split(".method")):
			add_newline = False
			if i!=0:
				method_part=part.split(".end method")[0]
				method_body = method_part.strip().split('\n')
				for line in method_body:
					if not line.strip().startswith('.') and not line.strip().startswith('#') and line.strip():
						method_line = line.strip().split()
						if method_line[0] in dalvik_opcodes:
							add_newline = True
							opcode_seq += dalvik_opcodes[method_line[0]]
				if  add_newline:
					opcode_seq += '\n'
	return opcode_seq


def byte_apk(path):

	dalvik_opcodes = {}
	with open("DalvikOpcodes.txt") as fop:
		for linee in fop:
			(key, val) = linee.split()
			dalvik_opcodes[key] = val

	smali_feature = ''

	pattern =  re.compile(r"\.smali$")
	smaliPathList = []
	dirList = os.listdir(path)
	for tmp_dir in dirList:
		if re.match('smali',tmp_dir):
			smaliPathList.append(tmp_dir)

	for smaliPath in smaliPathList:
		searchDir = os.path.join(path, smaliPath)
		
		for root, dirs, files in os.walk(searchDir):
			for file in files:
				if pattern.findall(file):
					smali_feature += get_opcode_seq(os.path.join(root, file),dalvik_opcodes)

	smali_feature = smali_feature.split('\n')

	dalvik_tokens = get_davikcode_token()

	smali_token = ''

	for line in smali_feature:
		if line !='':
			i = 0
			while i!=len(line)/2:
				tmp_token = line[i*2:(i+1)*2]
				tmp_token = dalvik_tokens[tmp_token]
				smali_token += str(tmp_token) + '|'
				i+=1

	return smali_token

data_file = codecs.open("apk_data.csv", 'w', 'utf-8')

def extract_bytecode(apkDir,label):
	apkList = os.listdir(apkDir)
	
	for apk in tqdm(apkList):
		apkPath = apkDir+"/"+apk
		try:
			smali_token = byte_apk(apkPath)
			data_file.write("".join([apk, ",", smali_token, ",", str(label), "\n"]))
		except:
			print("error")

#0 good # 1 adware #2 ramsomware #3 scareware #4 sms
'''
apkDir4 = "D://reverse_data/Benign_2015"
extract_bytecode(apkDir4,0)

apkDir5 = "D://reverse_data/Benign_2016"
extract_bytecode(apkDir5,0)

apkDir6 = "D://reverse_data/Benign_2017"
extract_bytecode(apkDir6,0)

apkDir0 = "D://reverse_data/Adware"
extract_bytecode(apkDir0,1)
		
apkDir1 = "D://reverse_data/Ransomware"
extract_bytecode(apkDir1,2)

apkDir2 = "D://reverse_data/Scareware"
extract_bytecode(apkDir2,3)

apkDir3 = "D://reverse_data/SMS"
extract_bytecode(apkDir3,4)

'''