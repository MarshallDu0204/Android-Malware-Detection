import os
import re
import codecs
from smali import Smali
from tqdm import tqdm


def byte_apk(path):

	smali_feature = []

	pattern =  re.compile(r"\.smali$")
	smaliPathList = []
	dirList = os.listdir(path)
	for tmp_dir in dirList:
		if re.match('smali',tmp_dir):
			smaliPathList.append(tmp_dir)

	for smaliPath in smaliPathList:
		searchDir = os.path.join(path, smaliPath)
		
		for root, dirs, files in os.walk(searchDir):
			for file in files:
				if pattern.findall(file):
					smali_feature.append(Smali(os.path.join(root, file)))

	feature = ''
	for tmp_smali in smali_feature:
		feature += tmp_smali.getFeature()

	return feature

data_file = codecs.open("apk_data.csv", 'w', 'utf-8')

def extract_bytecode(apkDir,label):
	apkList = os.listdir(apkDir)
	
	for apk in tqdm(apkList):
		apkPath = apkDir+"/"+apk
		try:
			smali_feature = byte_apk(apkPath)
			data_file.write("".join([apk, ",", smali_feature, ",", str(label), "\n"]))
		except:
			print("error")

#0 good # 1 adware #2 ramsomware #3 scareware #4 sms

apkDir0 = "D://reverse_app/Adware"
extract_bytecode(apkDir0,1)
		
apkDir1 = "D://reverse_app/Ransomware"
extract_bytecode(apkDir1,2)

apkDir2 = "D://reverse_app/Scareware"
extract_bytecode(apkDir2,3)

apkDir3 = "D://reverse_app/SMS"
extract_bytecode(apkDir3,4)

apkDir4 = "D://reverse_app/Benign_2015"
extract_bytecode(apkDir4,0)

apkDir5 = "D://reverse_app/Benign_2016"
extract_bytecode(apkDir5,0)

apkDir6 = "D://reverse_app/Benign_2017"
extract_bytecode(apkDir6,0)

data_file.close()