import os
import android_permission
from tqdm import tqdm
import codecs
import xml.etree.ElementTree as ET

def read_manifest(path):

	manifest_path = path+"/"+"AndroidManifest.xml"

	tree = ET.parse(manifest_path)
	treeRoot = tree.getroot()
	array_permissions = []

	for permission in treeRoot.findall('uses-permission'):
		item = permission.get('{http://schemas.android.com/apk/res/android}name')
		array_permissions.append(item)

	binaryPermission = ''
	for item in sorted(android_permission.AOSP_PERMISSIONS):

		if array_permissions.__contains__(item):
			binaryPermission += '1,'

		else:
			binaryPermission += '0,'

	return binaryPermission


data_file = codecs.open("apk_manifest.csv", 'w', 'utf-8')

def extract_apk(apkDir,label):
	apkList = os.listdir(apkDir)
	
	for apk in tqdm(apkList):
		apkPath = apkDir+"/"+apk
		try:
			manifest_featrue = read_manifest(apkPath)
			data_file.write("".join([manifest_featrue, str(label), "\n"]))
		except:
			print("error")

apkDir0 = "D://reverse_app/Adware"
extract_apk(apkDir0,1)
		
apkDir1 = "D://reverse_app/Ransomware"
extract_apk(apkDir1,2)

apkDir2 = "D://reverse_app/Scareware"
extract_apk(apkDir2,3)

apkDir3 = "D://reverse_app/SMS"
extract_apk(apkDir3,4)

apkDir4 = "D://reverse_app/Benign_2015"
extract_apk(apkDir4,0)

apkDir5 = "D://reverse_app/Benign_2016"
extract_apk(apkDir5,0)

apkDir6 = "D://reverse_app/Benign_2017"
extract_apk(apkDir6,0)

data_file.close()