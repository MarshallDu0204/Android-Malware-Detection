import os
import android_permission
from tqdm import tqdm
import numpy as np
import xml.etree.ElementTree as ET

def read_manifest(path):

	tree = ET.parse(path)
	treeRoot = tree.getroot()
	array_permissions = []

	for permission in treeRoot.findall('uses-permission'):
		item = permission.get('{http://schemas.android.com/apk/res/android}name')
		array_permissions.append(item)

	binaryPermission = []
	for item in sorted(android_permission.AOSP_PERMISSIONS):

		if array_permissions.__contains__(item):
			binaryPermission.append(1)

		else:
			binaryPermission.append(0)

	for i in range(31):
		binaryPermission.append(0)

	binaryPermission = np.asarray(binaryPermission).reshape(19,19)

	return binaryPermission

def extract_apk(apkDir,label):
	apkList = os.listdir(apkDir)
	img_list = []
	label_list = []
	for apk in tqdm(apkList):
		apkPath = apkDir+"/"+apk
		try:
			manifest_featrue = read_manifest(apkPath)
			img_list.append(manifest_featrue)
			label_list.append(label)
		except:
			print("error")
	return np.asarray(img_list),np.asarray(label_list)

apkDir0 = "D://Manifest/Adware"
img0,label0 = extract_apk(apkDir0,1)
		
apkDir1 = "D://Manifest/Ransomware"
img1,label1 = extract_apk(apkDir1,2)

apkDir2 = "D://Manifest/Scareware"
img2,label2 = extract_apk(apkDir2,3)

apkDir3 = "D://Manifest/SMSmalware"
img3,label3 = extract_apk(apkDir3,4)

apkDir4 = "D://Manifest/Benign_2015"
img4,label4 = extract_apk(apkDir4,0)

apkDir5 = "D://Manifest/Benign_2016"
img5,label5 = extract_apk(apkDir5,0)

apkDir6 = "D://Manifest/Benign_2017"
img6,label6 = extract_apk(apkDir6,0)

data = np.concatenate((img0,img1,img2,img3,img4,img5,img6))
label = np.concatenate((label0,label1,label2,label3,label4,label5,label6))

print(data.shape)
print(label.shape)
np.save("manifest_data",data)
np.save("manifest_label",label)